name: Creating SonarQube server

on:
  workflow_dispatch:

jobs:

  sonar-qube:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: SSH into EC2 and deploy Angular app
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
          script: |
            su - sonaradmin
            cd /opt
            wget https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-7.0.2.4839-linux-x64.zip?_gl=1*cpo1pd*_gcl_au*NTUwMjE3MDQyLjE3NDMwNzEzNzA.*_ga*ODI1OTU1OTEyLjE3NDMwNzEzNzA.*_ga_9JZ0GZ5TC6*MTc0MzQwMTU0Mi4zLjEuMTc0MzQwMTU0Ni41Ny4wLjA.
            unzip 'sonar-scanner-cli-7.0.2.4839-linux-x64.zip?_gl=1*cpo1pd*_gcl_au*NTUwMjE3MDQyLjE3NDMwNzEzNzA.*_ga*ODI1OTU1OTEyLjE3NDMwNzEzNzA.*_ga_9JZ0GZ5TC6*MTc0MzQwMTU0Mi4zLjEuMTc0MzQwMTU0Ni41Ny4wLjA.'
            git clone -b develop https://${{ secrets.PAT_GITHUB }}@github.com/Rentte/Rentte-backend.git
            cd Rentte-backend/
            /opt/sonar-scanner-7.0.2.4839-linux-x64/bin/sonar-scanner \
            -Dsonar.projectKey=${{ secrets.SONAR_PROJECT_KEY }} \
            -Dsonar.sources=. \
            -Dsonar.host.url=http://${{ secrets.EC2_HOST }}:9000 \
            -Dsonar.token=${{ secrets.SONAR_TOKEN }}
